using System; using System.IO; using System.Linq; using System.Threading.Tasks; using MediaBrowser.Common.Configuration; using MediaBrowser.Controller.Plugins; using Microsoft.Extensions.Logging; namespace JellyfinCarouselPlugin; public class InjectionService : IServerEntryPoint { private readonly IApplicationPaths _appPaths; private readonly ILogger<InjectionService> _logger; public InjectionService(IApplicationPaths appPaths, ILogger<InjectionService> logger) { _appPaths = appPaths; _logger = logger; } public Task Run() { try { var jellyfinWebDir = Path.Combine(_appPaths.ProgramDataPath, "jellyfin-web"); if (!Directory.Exists(jellyfinWebDir)) { _logger.LogWarning("Jellyfin-web directory not found at {Path}. Will try other paths.", jellyfinWebDir); jellyfinWebDir = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "jellyfin-web"); } if (Directory.Exists(jellyfinWebDir)) { var indexFile = Path.Combine(jellyfinWebDir, "index.html"); if (File.Exists(indexFile)) { var content = File.ReadAllText(indexFile); string injectionTag = "<script src=\"/plugins/JellyfinCarouselPlugin/Web/carousel-layout.js\"></script>"; if (!content.Contains(injectionTag)) { content = content.Replace("</head>", $"    {injectionTag}\n</head>"); File.WriteAllText(indexFile, content); _logger.LogInformation("Successfully injected Media Carousel script into Jellyfin web UI."); } } } } catch (Exception ex) { _logger.LogError(ex, "Failed to inject Media Carousel script into index.html."); } return Task.CompletedTask; } public void Dispose() { } }
